<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>جدول المتابعة</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script type="module">
import Alpine from "https://cdn.jsdelivr.net/npm/alpinejs@3.13.7/dist/module.esm.min.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
window.Alpine = Alpine;
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDvvWNXn3Wht_6ki-uhbdkGzQTRa71HTTk",
  authDomain: "programme-hebdomadaire.firebaseapp.com",
  databaseURL: "https://programme-hebdomadaire-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "programme-hebdomadaire",
  storageBucket: "programme-hebdomadaire.firebasestorage.app",
  messagingSenderId: "476978354022",
  appId: "1:476978354022:web:6514dba81ee84fc4f15aa7",
  measurementId: "G-08HV2ZXPW"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
window.weeksComponent = function () {
  const now = new Date();
  const startYear = 2025;
  return {
    months:["يناير","فبراير","مارس","أبريل","ماي","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"],
    days:["الأحد","الإثنين","الثلاثاء","الأربعاء","الخميس"],
    currentMonth: now.getMonth(),
    currentYear: now.getFullYear(),
    selectedStudent: 0,
    selectedWeek: 1,
    showStats: false,
    loadingMain: true,
    loadingStats: false,
    statsLoaded: false,
    availableMonths: [],
    availableYears: [],
    souratesList: [],
    weeks: [],
    
    async openStats() {
  	this.showStats = true;
  	this.loadingStats = true;
  	this.statsLoaded = false;
  	history.pushState({ statsOpen: true }, "");
  	await this.$nextTick();
  	import("./statistiquesWidget.js").then(module => {
    	module.renderStatsWidget({
      	student: this.selectedStudent + 1,
      	year: this.currentYear,
      	month: this.currentMonth,
      	container: document.getElementById("statsContainer")
    	});
  	});
  	this.loadingStats = false;
      this.statsLoaded = true;
	},
	closeStats() {
	  this.showStats = false;
	  this.$refs.modalContent.innerHTML = "";
	  if(history.state && history.state.statsOpen) history.back();
	},
    init() {
      this.generateAllWeeks();
      this.loadSourates();
      this.loadAvailableYears();
      this.loadAvailableMonths();
      this.$watch("selectedWeek", () => this.loadAllRows());
      this.$watch("currentMonth", () => { this.generateAllWeeks(); this.loadAllRows(); });
      this.$watch("selectedStudent", () => { this.loadAvailableYears(); this.loadAvailableMonths(); this.loadAllRows(); });
      this.$watch("currentYear", () => { this.loadAvailableMonths(); this.generateAllWeeks(); this.loadAllRows(); });
      window.addEventListener("popstate", (event) => {
    	if(this.showStats) {
      	this.closeStats();
      	history.pushState(null, "");
    	}
  	});
  	Promise.all([
        	this.loadSourates(),
        	this.loadAvailableYears(),
        	this.loadAvailableMonths(),
      ]).then(() => {
        	this.loadingMain = false;
      });
    },
    async loadAvailableYears() {
      const snapshot = await get(child(ref(db), "students"));
      if (!snapshot.exists()) return;
      const data = snapshot.val();
      const student = this.selectedStudent === 0 ? "student1" : "student2";
      if (!data[student]) return;
      this.availableYears = Object.keys(data[student]).map(y => Number(y)).sort((a,b) => a - b);
    },
    async loadAvailableMonths() {
      const student = this.selectedStudent === 0 ? "student1" : "student2";
      const snapshot = await get(child(ref(db), `students/${student}/${this.currentYear}`));
      if (!snapshot.exists()) { this.availableMonths = []; return; }
      this.availableMonths = Object.keys(snapshot.val()).map(m => Number(m)).sort((a,b) => a - b);
    },
    async loadSourates() {
      const snapshot = await get(child(ref(db), "sourates"));
      if (!snapshot.exists()) return;
      const raw = snapshot.val();
      if (Array.isArray(raw)) this.souratesList = raw.filter(s => s);
      else this.souratesList = Object.keys(raw).sort((a,b)=>Number(a)-Number(b)).map(k => raw[k]);
    },
    getSourateName(index) {
      const idx = Number(index);
      if (!idx) return "-- --";
      const s = this.souratesList[idx - 1];
      return s && s.sourate ? s.sourate : "-- --";
    },
    generateAllWeeks() {
      this.weeks = [];
      const first = new Date(this.currentYear, this.currentMonth, 1);
      const weekday = first.getDay();
      const firstWeekSunday = new Date(first);
      firstWeekSunday.setDate(1 - weekday);
      for (let w = 0; w < 4; w++) {
        const base = new Date(firstWeekSunday);
        base.setDate(firstWeekSunday.getDate() + w * 7);
        const rows = [];
        for (let i = 0; i < 5; i++) {
          const d = new Date(base);
          d.setDate(base.getDate() + i);
          rows.push({
            day: this.days[i],
            date: d.getDate(),
            month: d.getMonth() + 1,
            _fromSura:"",
            _fromAya:"",
            _toSura:"",
            _toAya:"",
            _note:"",
            _errors:[false,false,false],
            _alerts:[false,false,false,false,false,false],
            total: null
          });
        }
        this.weeks.push(rows);
      }
      // Déterminer la semaine actuelle
  	const today = new Date();
  	let weekIndex = 1;
  	for (let w = 0; w < this.weeks.length; w++) {
    	const weekStart = new Date(this.currentYear, this.currentMonth, this.weeks[w][0].date);
    	const weekEnd = new Date(this.currentYear, this.currentMonth, this.weeks[w][this.weeks[w].length - 1].date);
    	if (today >= weekStart && today <= weekEnd) {
      	weekIndex = w + 1;
      	break;
    	}
  	}
  	this.selectedWeek = weekIndex;
      this.loadAllRows();
    },
    async loadAllRows() {
      if (!this.weeks.length) return;
      const rows = this.weeks[this.selectedWeek - 1];
      rows.forEach(row => {
        row._fromSura = "";
        row._fromAya = "";
        row._toSura = "";
        row._toAya  = "";
        row._note   = "";
        row._errors = [false,false,false];
        row._alerts = [false,false,false,false,false,false];
        row.total   = null;
      });
      const student = this.selectedStudent === 0 ? "student1" : "student2";
      const path = `students/${student}/${this.currentYear}/${this.currentMonth}/${this.selectedWeek}`;
      const snapshot = await get(child(ref(db), path));
      if (!snapshot.exists()) return;
      const saved = snapshot.val();
      rows.forEach((row, i) => {
        if (!saved[i]) return;
        row._fromSura = saved[i].fromSura ?? "";
        row._fromAya  = saved[i].fromAya ?? "";
        row._toSura   = saved[i].toSura ?? "";
        row._toAya    = saved[i].toAya ?? "";
        row._note     = saved[i].note ?? "";
        row._errors   = saved[i].errors ?? [false,false,false];
        row._alerts   = saved[i].alerts ?? [false,false,false,false,false,false];
        row.total     = saved[i].total ?? null;
      });
    },
    category(total) {
      if (total === null) return "-- --";
      if (total >= 16) return "ممتاز";
      if (total >= 14) return "جيد جدا";
      if (total >= 12) return "جيد";
      if (total >= 10) return "مقبول";
      return "راسب";
    },
    arabicNumber(n) {
      return String(n).replace(/\d/g, d => "٠١٢٣٤٥٦٧٨٩"[d]);
    }
  };
};
Alpine.start();
</script>
<style>
  [x-cloak] {display: none !important;}
  .outer-frame{border:2px solid #000;border-radius:2px;display:inline-block}
  table.inner{border-collapse:collapse;width:100%}
  table.inner th,table.inner td{border:1px solid #000;padding:.75rem;white-space:nowrap;vertical-align:middle}
  input[type="checkbox"]:checked::before{content:"✗";color:red;font-size:1.2em;font-weight:bold;position:absolute;top:40%;left:50%;transform:translate(-50%,-50%)}
  input[type="checkbox"]{position:relative;appearance:none;width:1.05rem;height:1.05rem;border:2px solid #6b7280;border-radius:3px}
  select:focus{border-color: #0369a1 !important; outline: none;}
</style>
</head>
<body class="p-6 bg-white font-sans" x-data="weeksComponent()">
<!-- Spinner -->
<template x-if="loadingMain || loadingStats">
  <div class="fixed inset-0 bg-white bg-opacity-70 flex items-center justify-center z-50">
    <div class="animate-spin rounded-full h-12 w-12 border-4 border-gray-300 border-t-[#0369a1]"></div>
  </div>
</template>
<!-- Mois + Année -->
<div class="flex justify-center mb-4 gap-4">
  <select x-model.number="currentMonth" class="border bg-blue-50 rounded shadow p-2">
    <template x-for="m in availableMonths" :key="m">
      <option :value="m" x-text="months[m]"></option>
    </template>
  </select>
  <select x-model.number="currentYear" class="border bg-green-50 rounded shadow p-2">
    <template x-for="y in availableYears" :key="y">
      <option :value="y" x-text="arabicNumber(y)"></option>
    </template>
  </select>
</div>
<!-- Semaines -->
<div class="flex justify-center gap-2 mb-4">
  <template x-for="i in [1,2,3,4]" :key="i">
    <button @click="selectedWeek=i" class="px-4 py-2 border rounded shadow" :class="selectedWeek===i?'bg-[#0369a1] text-white border-[#0369a1]':'bg-yellow-50 text-[#0369a1]'">
      الأسبوع <span x-text="arabicNumber(i)"></span>
    </button>
  </template>
</div>
<!-- Étudiants -->
<div class="flex flex-col items-center mb-4 w-full">
  <div class="flex gap-4 w-full">
    <template x-for="(student,i) in ['عزام المحمود','صالح المحمود']" :key="i">
      <button @click="selectedStudent=i" class="px-5 py-2 rounded-t-lg border-2 border-b-0" :class="selectedStudent===i?'bg-[#0369a1] text-white border-[#0369a1]':'text-[#0369a1] border-white'">
        <span x-text="student"></span>
      </button>
    </template>
  </div>
  <div class="bg-[#0369a1] h-1 w-full"></div>
</div>
<!-- Tableau -->
<div x-show="weeks.length>0" class="overflow-x-auto w-full">
  <div class="outer-frame">
    <table class="inner table-auto text-center">
      <thead>
        <tr>
          <th rowspan="3" style="width:13%">اليوم والتاريخ</th>
          <th colspan="4">صفحات العرض</th>
          <th rowspan="3" style="width:9%">عدد الأخطاء</th>
          <th rowspan="3" style="width:9%">عدد التنبيهات</th>
          <th rowspan="3" style="width:9%">التقدير</th>
          <th rowspan="3" style="width:20%">الملاحظة</th>
        </tr>
        <tr><th colspan="2">من</th><th colspan="2">إلى</th></tr>
        <tr><th style="width:18%">سورة</th><th style="width:10%">آية</th><th style="width:18%">سورة</th><th style="width:10%">آية</th></tr>
      </thead>
      <tbody>
        <template x-if="weeks[selectedWeek-1]">
          <template x-for="(row,idx) in weeks[selectedWeek-1]" :key="idx">
            <tr>
              <td><span x-text="row.day"></span> <span x-text="arabicNumber(row.date)+'/'+arabicNumber(row.month)"></span></td>
              <td><span x-text="getSourateName(row._fromSura)"></span></td>
              <td><span x-text="row._fromAya ? arabicNumber(row._fromAya) : '-- --'"></span></td>
              <td><span x-text="getSourateName(row._toSura)"></span></td>
              <td><span x-text="row._toAya ? arabicNumber(row._toAya) : '-- --'"></span></td>
              <td>
                <div class="flex justify-center gap-3">
                  <template x-for="(v,i) in row._errors" :key="i">
                    <input type="checkbox" :checked="v" disabled>
                  </template>
                </div>
              </td>
              <td>
                <div class="flex justify-center gap-2 flex-wrap">
                  <template x-for="(v,i) in row._alerts" :key="i">
                    <input type="checkbox" :checked="v" disabled>
                  </template>
                </div>
              </td>
              <td class="font-bold"><span x-text="category(row.total)"></span></td>
              <td><span x-text="row._note || '-- --'"></span></td>
            </tr>
          </template>
        </template>
      </tbody>
    </table>
  </div>
</div>
<div class="mt-6 flex justify-center">
  <button @click="openStats()" class="px-6 py-3 bg-[#0369a1] text-white rounded shadow hover:bg-[#025a8a]">
    عرض الإحصائيات
  </button>
</div>
<!-- Modale Statistiques -->
<div x-cloak x-show="showStats" x-transition class="fixed inset-0 bg-white z-50 overflow-y-auto">
  <div class="p-2">
    <button @click="closeStats()" class="text-blue-600 text-lg mb-4 px-2">العودة</button>
    <div id="statsContainer"></div>
  </div>
</div>
</body>

</html>

