<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>جدول المتابعة</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script type="module">
import Alpine from "https://cdn.jsdelivr.net/npm/alpinejs@3.13.7/dist/module.esm.min.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
window.Alpine = Alpine;
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDvvWNXn3Wht_6ki-uhbdkGzQTRa71HTTk",
  authDomain: "programme-hebdomadaire.firebaseapp.com",
  databaseURL: "https://programme-hebdomadaire-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "programme-hebdomadaire",
  storageBucket: "programme-hebdomadaire.firebasestorage.app",
  messagingSenderId: "476978354022",
  appId: "1:476978354022:web:6514dba81ee84fc4f15aa7",
  measurementId: "G-08HV2ZXPW"
};
const params = new URLSearchParams(window.location.search);
const DEPOT = params.get("depot");
const ALLOWED_DEPOTS = ["madrasa1", "madrasa2"];

if (!ALLOWED_DEPOTS.includes(DEPOT)) {
  document.body.innerHTML = `<div style="padding:2rem;text-align:center;font-size:1.2rem">رابط غير صالح</div>`;
  throw new Error("Invalid depot");
}

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
window.weeksComponent = function () {
  const now = new Date();
  const startYear = 2025;
  return {
    currentDepot: DEPOT,
    months:["يناير","فبراير","مارس","أبريل","ماي","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"],
    days:["الأحد","الإثنين","الثلاثاء","الأربعاء","الخميس"],
    currentMonth: now.getMonth(),
    currentYear: now.getFullYear(),
    selectedStudentId: null,
    selectedWeek: 1,
    showStats: false,
    loadingMain: true,
    loadingStats: false,
    statsLoaded: false,
    selectedType: "hifz",
	types: [{ key: "hifz", label: "الحفظ" }, { key: "review", label: "المراجعة" }, { key: "link", label: "الربط" }],
    availableMonths: [],
    availableYears: [],
    souratesList: [],
    students: [],
    weeks: [],
    
    async openStats() {
  	this.showStats = true;
  	this.loadingStats = true;
  	this.statsLoaded = false;
  	history.pushState({ statsOpen: true }, "");
  	await this.$nextTick();
  	import("./statistiquesWidget.js").then(module => {
    	module.renderStatsWidget({
    	  depot: this.currentDepot,
      	studentId: this.selectedStudentId,
      	year: this.currentYear,
      	month: this.currentMonth,
      	type: this.selectedType,
      	container: document.getElementById("statsContainer")
    	});
  	});
  	this.loadingStats = false;
      this.statsLoaded = true;
	},
	closeStats() {
	  this.showStats = false;
	  this.$refs.modalContent.innerHTML = "";
	  if(history.state && history.state.statsOpen) history.back();
	},
    init() {
      this.generateAllWeeks();
      this.loadSourates();
      this.loadStudents();
  	this.$watch("selectedStudentId", async () => {
  	  this.availableYears = [];
    	this.availableMonths = [];
    	this.currentYear = null;
    	this.currentMonth = null;
		await this.loadAvailableYears();
		await this.loadAvailableMonths();
	  });
	  this.$watch("currentYear", async () => {
    	if (!this.selectedStudentId) return;
    	await this.loadAvailableMonths();
  	});
	  this.$watch("currentMonth", () => {
    	if (this.currentMonth === null) return;
    	this.generateAllWeeks();
  	});
      this.$watch("selectedWeek", () => this.loadAllRows());
      this.$watch("selectedType", () => this.loadAllRows());
      this.loadingMain = false;
    },
    async loadStudents() {
  	const snapshot = await get(child(ref(db), `studentsMeta/${this.currentDepot}`));
  	if (!snapshot.exists()) return;
  	const raw = snapshot.val();
  	this.students = Object.entries(raw).map(([id, data]) => ({ id, name: data.name}));
	},
    async loadAvailableYears() {
      if (!this.selectedStudentId) {this.availableYears = []; return;}
  	const snapshot = await get(child(ref(db), `students/${this.currentDepot}/${this.selectedStudentId}`));
  	if (!snapshot.exists()) {this.availableYears = []; return;}
  	const students = snapshot.val();
  	this.availableYears = Object.keys(snapshot.val())
    	.map(y => Number(y))
    	.sort((a, b) => a - b);
  	this.currentYear = this.availableYears[0];
	},
    async loadAvailableMonths() {
  	if (!this.selectedStudentId || this.currentYear === null) {
    	this.availableMonths = [];
    	return;
  	}
  	const snapshot = await get(child(ref(db), `students/${this.currentDepot}/${this.selectedStudentId}/${this.currentYear}`));
  	if (!snapshot.exists()) {
    	this.availableMonths = [];
    	return;
  	}
  	this.availableMonths = Object.keys(snapshot.val())
    	.map(m => Number(m))
    	.sort((a, b) => a - b);
  	if (!this.availableMonths.includes(this.currentMonth)) {
  	  this.currentMonth = this.availableMonths[0] ?? null;
	  }
	},
    async loadSourates() {
      const snapshot = await get(child(ref(db), "sourates"));
      if (!snapshot.exists()) return;
      const raw = snapshot.val();
      if (Array.isArray(raw)) this.souratesList = raw.filter(s => s);
      else this.souratesList = Object.keys(raw).sort((a,b)=>Number(a)-Number(b)).map(k => raw[k]);
    },
    getSourateName(index) {
      const idx = Number(index);
      if (!idx) return "-- --";
      const s = this.souratesList[idx - 1];
      return s && s.sourate ? s.sourate : "-- --";
    },
    generateAllWeeks() {
  	this.weeks = [];
  	const year  = this.currentYear;
  	const month = this.currentMonth;
  	const firstOfMonth = new Date(year, month, 1);
  	const lastOfMonth  = new Date(year, month + 1, 0);
  
  	// Point de départ : dimanche de la semaine du 1er
  	const start = new Date(firstOfMonth);
  	start.setDate(start.getDate() - start.getDay());
  	let sunday = new Date(start);
  
  	while (true) {
    	const week = [];
    	let hasDayInMonth = false;

    	// Construction dim → jeu à partir du dimanche
    	for (let i = 0; i <= 4; i++) {
      	const d = new Date(sunday);
      	d.setDate(sunday.getDate() + i);
      	if (d.getMonth() === month) {hasDayInMonth = true;}
      	week.push({
        	day: this.days[d.getDay()],
        	date: d.getDate(),
        	month: d.getMonth() + 1,
        	_fromSura:"",
        	_fromAya:"",
        	_toSura:"",
        	_toAya:"",
        	_note:"",
        	_errors:[false,false,false],
        	_alerts:[false,false,false,false,false,false],
        	total: null
      	});
    	}
    	// La semaine existe si au moins un jour appartient au mois
    	if (hasDayInMonth) {this.weeks.push(week);}
    	// Arrêt après la dernière semaine utile
    	if (sunday > lastOfMonth && !hasDayInMonth) {break;}
    	sunday.setDate(sunday.getDate() + 7);
  	}
  
  	// Suppression de la semaine précédente si chevauchement
      if (this.weeks.length > 1) {
        const firstWeek = this.weeks[0];
        const hasPrevMonthDay = firstWeek.some(d => d.month - 1 !== this.currentMonth);
        if (hasPrevMonthDay) {this.weeks.shift();}
      }

  	// Sélection automatique de la semaine courante
  	const today = new Date();
  	this.selectedWeek = 1;
  	this.weeks.forEach((week, i) => {
    	const start = new Date(year, week[0].month - 1, week[0].date);
    	const end   = new Date(year, week[4].month - 1, week[4].date);
    	if (today >= start && today <= end) {this.selectedWeek = i + 1;}
  	});
  	this.$nextTick(() => this.loadAllRows());
	},
    async loadAllRows() {
  	if (!this.weeks.length) return;
  	const rows = this.weeks[this.selectedWeek - 1];
  	rows.forEach(row => {
  	  row._fromSura = "";
  	  row._fromAya  = "";
  	  row._toSura   = "";
  	  row._toAya    = "";
  	  row._note     = "";
  	  row._errors   = [false,false,false];
  	  row._alerts   = [false,false,false,false,false,false];
  	  row.total     = null;
	  });
  	const student = this.selectedStudentId;
	  if (!student) return;
  	const basePath = `students/${this.currentDepot}/${student}/${this.currentYear}/${this.currentMonth}/${this.selectedWeek}`;
  	const snapshot = await get(child(ref(db), basePath));
  	if (!snapshot.exists()) return;
  	const savedWeek = snapshot.val();
  	rows.forEach((row, i) => {
    	if (!savedWeek[i]) return;
    	if (!savedWeek[i][this.selectedType]) return;
    	const saved = savedWeek[i][this.selectedType];
    	row._fromSura = saved.fromSura ?? "";
    	row._fromAya  = saved.fromAya ?? "";
    	row._toSura   = saved.toSura ?? "";
    	row._toAya    = saved.toAya ?? "";
    	row._note     = saved.note ?? "";
    	row._errors   = saved.errors ?? [false,false,false];
    	row._alerts   = saved.alerts ?? [false,false,false,false,false,false];
    	row.total       = saved.total ?? null;
  	});
	},
    category(total) {
      if (total === null) return "-- --";
      if (total >= 16) return "ممتاز";
      if (total >= 14) return "جيد جدا";
      if (total >= 12) return "جيد";
      if (total >= 10) return "مقبول";
      return "راسب";
    },
    arabicNumber(n) {return String(n).replace(/\d/g, d => "٠١٢٣٤٥٦٧٨٩"[d]);}
  };
};
Alpine.start();
</script>
<style>
  [x-cloak] {display: none !important;}
  .outer-frame{border:2px solid #000;border-radius:2px;display:inline-block}
  table.inner{border-collapse:collapse;width:100%}
  table.inner th,table.inner td{border:1px solid #000;padding:.75rem;white-space:nowrap;vertical-align:middle}
  input[type="checkbox"]:checked::before{content:"✗";color:red;font-size:1.2em;font-weight:bold;position:absolute;top:40%;left:50%;transform:translate(-50%,-50%)}
  input[type="checkbox"]{position:relative;appearance:none;width:1.05rem;height:1.05rem;border:2px solid #6b7280;border-radius:3px}
  select:focus{border-color: #0369a1 !important; outline: none;}
</style>
</head>
<body class="p-6 bg-white font-sans" x-data="weeksComponent()">
<!-- Spinner -->
<template x-if="loadingMain || loadingStats">
  <div class="fixed inset-0 bg-white bg-opacity-70 flex items-center justify-center z-50">
    <div class="animate-spin rounded-full h-12 w-12 border-4 border-gray-300 border-t-[#0369a1]"></div>
  </div>
</template>
<!-- Mois + Année -->
<div class="flex justify-center mb-4 gap-4">
  <select x-model.number="currentMonth" class="border bg-blue-50 rounded shadow p-2">
    <template x-for="m in availableMonths" :key="m">
      <option :value="m" x-text="months[m]"></option>
    </template>
  </select>
  <select x-model.number="currentYear" class="border bg-green-50 rounded shadow p-2">
    <template x-for="y in availableYears" :key="y">
      <option :value="y" x-text="arabicNumber(y)"></option>
    </template>
  </select>
</div>
<!-- Semaines -->
<div class="flex justify-center gap-2 mb-4">
  <template x-for="(week, i) in weeks" :key="i">
    <button @click="selectedWeek = i + 1" class="px-4 py-2 border rounded"
      :class="selectedWeek === i + 1 ? 'bg-[#0369a1] text-white border-[#0369a1]' : 'bg-white text-[#0369a1] border-[#0369a1] hover:bg-gray-100'">    الأسبوع <span x-text="arabicNumber(i + 1)"></span>
    </button>
  </template>
</div>
<!-- Étudiants -->
<div class="flex justify-center mb-4">
  <select x-model="selectedStudentId" class="border p-2 text-center">
    <option value="" selected>اختر طالباً</option>
    <template x-for="s in students" :key="s.id">
      <option :value="s.id" x-text="s.name"></option>
    </template>
  </select>
</div>
<!--Type-->
<div class="flex flex-col items-center mb-4 w-full relative" :class="!selectedStudentId ? 'opacity-50 pointer-events-none' : ''">
  <div class="flex gap-4 w-full">
    <template x-for="t in types" :key="t.key">
      <button @click="selectedType = t.key" class="px-5 py-2 rounded-t-lg border-2 border-b-0" :class="selectedType === t.key ? 'bg-[#0369a1] text-white border-[#0369a1]' : 'text-[#0369a1] border-white hover:bg-gray-100'">
        <span x-text="t.label"></span>
      </button>
    </template>
  </div>
  <div class="bg-[#0369a1] h-1 w-full"></div>
</div>
<!-- Tableau -->
<div x-show="weeks.length>0" class="overflow-x-auto w-full" :class="!selectedStudentId ? 'opacity-50 pointer-events-none' : ''">
  <div class="outer-frame">
    <table class="inner table-auto text-center">
      <thead>
        <tr>
          <th rowspan="3" style="width:13%">اليوم والتاريخ</th>
          <th colspan="4">صفحات العرض</th>
          <th rowspan="3" style="width:9%">عدد الأخطاء</th>
          <th rowspan="3" style="width:9%">عدد التنبيهات</th>
          <th rowspan="3" style="width:9%">التقدير</th>
          <th rowspan="3" style="width:20%">الملاحظة</th>
        </tr>
        <tr><th colspan="2">من</th><th colspan="2">إلى</th></tr>
        <tr><th style="width:18%">سورة</th><th style="width:10%">آية</th><th style="width:18%">سورة</th><th style="width:10%">آية</th></tr>
      </thead>
      <tbody>
        <template x-if="weeks[selectedWeek-1]">
          <template x-for="(row,idx) in weeks[selectedWeek-1]" :key="idx">
            <tr>
              <td><span x-text="row.day"></span> <span x-text="arabicNumber(row.date)+'/'+arabicNumber(row.month)"></span></td>
              <td><span x-text="getSourateName(row._fromSura)"></span></td>
              <td><span x-text="row._fromAya ? arabicNumber(row._fromAya) : '-- --'"></span></td>
              <td><span x-text="getSourateName(row._toSura)"></span></td>
              <td><span x-text="row._toAya ? arabicNumber(row._toAya) : '-- --'"></span></td>
              <td>
                <div class="flex justify-center gap-3">
                  <template x-for="(v,i) in row._errors" :key="i">
                    <input type="checkbox" :checked="v" disabled>
                  </template>
                </div>
              </td>
              <td>
                <div class="flex justify-center gap-2 flex-wrap">
                  <template x-for="(v,i) in row._alerts" :key="i">
                    <input type="checkbox" :checked="v" disabled>
                  </template>
                </div>
              </td>
              <td class="font-bold"><span x-text="row.total === null ? '-- --' : category(row.total)"></span></td>
              <td><span x-text="row._note || '-- --'"></span></td>
            </tr>
          </template>
        </template>
      </tbody>
    </table>
  </div>
</div>
<div class="mt-6 flex justify-center">
  <button @click="openStats()" class="px-6 py-3 bg-[#0369a1] text-white rounded shadow hover:bg-[#025a8a]" :class="!selectedStudentId ? 'opacity-50 pointer-events-none' : ''">
    عرض الإحصائيات
  </button>
</div>
<!-- Modale Statistiques -->
<div x-cloak x-show="showStats" x-transition class="fixed inset-0 bg-white z-50 overflow-y-auto">
  <div class="p-2">
    <button @click="closeStats()" class="text-blue-600 text-lg mb-4 px-2">العودة</button>
    <div id="statsContainer"></div>
  </div>
</div>
</body>
</html>
